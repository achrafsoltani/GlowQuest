package render

import "github.com/AchrafSoltani/glow"

// 4×6 bitmap font glyphs. Each byte is a row of 4 bits (MSB-first).
var glyphData = map[byte][6]uint8{
	'A': {0x6, 0x9, 0x9, 0xF, 0x9, 0x9},
	'B': {0xE, 0x9, 0xE, 0x9, 0x9, 0xE},
	'C': {0x7, 0x8, 0x8, 0x8, 0x8, 0x7},
	'D': {0xE, 0x9, 0x9, 0x9, 0x9, 0xE},
	'E': {0xF, 0x8, 0xE, 0x8, 0x8, 0xF},
	'F': {0xF, 0x8, 0xE, 0x8, 0x8, 0x8},
	'G': {0x7, 0x8, 0x8, 0xB, 0x9, 0x7},
	'H': {0x9, 0x9, 0xF, 0x9, 0x9, 0x9},
	'I': {0xE, 0x4, 0x4, 0x4, 0x4, 0xE},
	'J': {0x7, 0x2, 0x2, 0x2, 0xA, 0x4},
	'K': {0x9, 0xA, 0xC, 0xC, 0xA, 0x9},
	'L': {0x8, 0x8, 0x8, 0x8, 0x8, 0xF},
	'M': {0x9, 0xF, 0xF, 0x9, 0x9, 0x9},
	'N': {0x9, 0xD, 0xF, 0xB, 0x9, 0x9},
	'O': {0x6, 0x9, 0x9, 0x9, 0x9, 0x6},
	'P': {0xE, 0x9, 0x9, 0xE, 0x8, 0x8},
	'Q': {0x6, 0x9, 0x9, 0x9, 0xB, 0x6},
	'R': {0xE, 0x9, 0x9, 0xE, 0xA, 0x9},
	'S': {0x7, 0x8, 0x6, 0x1, 0x1, 0xE},
	'T': {0xF, 0x4, 0x4, 0x4, 0x4, 0x4},
	'U': {0x9, 0x9, 0x9, 0x9, 0x9, 0x6},
	'V': {0x9, 0x9, 0x9, 0x9, 0x6, 0x6},
	'W': {0x9, 0x9, 0x9, 0xF, 0xF, 0x9},
	'X': {0x9, 0x9, 0x6, 0x6, 0x9, 0x9},
	'Y': {0x9, 0x9, 0x6, 0x4, 0x4, 0x4},
	'Z': {0xF, 0x1, 0x2, 0x4, 0x8, 0xF},

	'a': {0x0, 0x0, 0x6, 0x9, 0xB, 0x5},
	'b': {0x8, 0x8, 0xE, 0x9, 0x9, 0xE},
	'c': {0x0, 0x0, 0x7, 0x8, 0x8, 0x7},
	'd': {0x1, 0x1, 0x7, 0x9, 0x9, 0x7},
	'e': {0x0, 0x0, 0x6, 0xF, 0x8, 0x7},
	'f': {0x3, 0x4, 0xE, 0x4, 0x4, 0x4},
	'g': {0x0, 0x0, 0x7, 0x9, 0x7, 0xE},
	'h': {0x8, 0x8, 0xE, 0x9, 0x9, 0x9},
	'i': {0x4, 0x0, 0x4, 0x4, 0x4, 0x4},
	'j': {0x2, 0x0, 0x2, 0x2, 0xA, 0x4},
	'k': {0x8, 0x8, 0xA, 0xC, 0xA, 0x9},
	'l': {0xC, 0x4, 0x4, 0x4, 0x4, 0xE},
	'm': {0x0, 0x0, 0x9, 0xF, 0x9, 0x9},
	'n': {0x0, 0x0, 0xE, 0x9, 0x9, 0x9},
	'o': {0x0, 0x0, 0x6, 0x9, 0x9, 0x6},
	'p': {0x0, 0x0, 0xE, 0x9, 0xE, 0x8},
	'q': {0x0, 0x0, 0x7, 0x9, 0x7, 0x1},
	'r': {0x0, 0x0, 0xB, 0xC, 0x8, 0x8},
	's': {0x0, 0x0, 0x7, 0xC, 0x3, 0xE},
	't': {0x4, 0x4, 0xE, 0x4, 0x4, 0x3},
	'u': {0x0, 0x0, 0x9, 0x9, 0x9, 0x7},
	'v': {0x0, 0x0, 0x9, 0x9, 0x6, 0x6},
	'w': {0x0, 0x0, 0x9, 0x9, 0xF, 0x9},
	'x': {0x0, 0x0, 0x9, 0x6, 0x6, 0x9},
	'y': {0x0, 0x0, 0x9, 0x9, 0x7, 0xE},
	'z': {0x0, 0x0, 0xF, 0x2, 0x4, 0xF},

	'0': {0x6, 0x9, 0xB, 0xD, 0x9, 0x6},
	'1': {0x4, 0xC, 0x4, 0x4, 0x4, 0xE},
	'2': {0x6, 0x9, 0x2, 0x4, 0x8, 0xF},
	'3': {0xF, 0x2, 0x6, 0x1, 0x9, 0x6},
	'4': {0x2, 0x6, 0xA, 0xF, 0x2, 0x2},
	'5': {0xF, 0x8, 0xE, 0x1, 0x9, 0x6},
	'6': {0x6, 0x8, 0xE, 0x9, 0x9, 0x6},
	'7': {0xF, 0x1, 0x2, 0x4, 0x4, 0x4},
	'8': {0x6, 0x9, 0x6, 0x9, 0x9, 0x6},
	'9': {0x6, 0x9, 0x9, 0x7, 0x1, 0x6},

	' ':  {0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
	'.':  {0x0, 0x0, 0x0, 0x0, 0x0, 0x4},
	',':  {0x0, 0x0, 0x0, 0x0, 0x4, 0x8},
	'!':  {0x4, 0x4, 0x4, 0x4, 0x0, 0x4},
	'?':  {0x6, 0x9, 0x2, 0x4, 0x0, 0x4},
	'-':  {0x0, 0x0, 0x0, 0xF, 0x0, 0x0},
	'\'': {0x4, 0x4, 0x0, 0x0, 0x0, 0x0},
	':':  {0x0, 0x4, 0x0, 0x0, 0x4, 0x0},
}

const (
	glyphW     = 4
	glyphH     = 6
	charSpaceX = 5 // glyph width + 1px spacing
	charSpaceY = 8 // glyph height + 2px spacing
)

// DrawText renders a string at (x, y) using the 4×6 bitmap font.
func DrawText(sc *ScaledCanvas, text string, x, y int, color glow.Color) {
	cx := x
	for i := 0; i < len(text); i++ {
		ch := text[i]
		glyph, ok := glyphData[ch]
		if !ok {
			cx += charSpaceX
			continue
		}
		for row := 0; row < glyphH; row++ {
			bits := glyph[row]
			for col := 0; col < glyphW; col++ {
				if bits&(0x8>>col) != 0 {
					sc.SetPixel(cx+col, y+row, color)
				}
			}
		}
		cx += charSpaceX
	}
}

// TextWidth returns the pixel width of a string rendered with the bitmap font.
func TextWidth(text string) int {
	if len(text) == 0 {
		return 0
	}
	return len(text)*charSpaceX - 1
}
